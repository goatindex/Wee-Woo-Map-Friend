!function(){"use strict";function e(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>{clearTimeout(o),e(...n)},t)}}window.AppBootstrap={async init(){console.log("AppBootstrap: Starting application initialization");try{await this.waitForNativeFeatures();const e=DeviceContext.getContext();console.log("AppBootstrap: Device context initialized:",e),this.applyDeviceStyles(e),this.initResponsiveHandling(),this.setupOrientationHandling(),await this.initNativeIntegration(),this.initMap(),this.setupUI(),window.MobileDocsNav&&(console.log("AppBootstrap: Initializing mobile documentation navigation"),window.MobileDocsNav.init()),await this.loadComponents(),this.setupEventHandlers(),this.handleInitialLocation(),console.log("AppBootstrap: Application initialization complete")}catch(e){console.error("AppBootstrap: Initialization failed:",e),window.ErrorUI&&ErrorUI.showError("Failed to initialize application",e.message)}},waitForNativeFeatures:async()=>new Promise(e=>{window.NativeFeatures?(window.addEventListener("nativeFeaturesReady",t=>{console.log("AppBootstrap: Native features ready:",t.detail),e(t.detail)},{once:!0}),setTimeout(()=>{console.log("AppBootstrap: Native features timeout, continuing with web-only"),e({isNative:!1})},1e3)):e({isNative:!1})}),applyDeviceStyles(e){const t=document.body;t.classList.remove("device-mobile","device-tablet","device-desktop","device-large"),t.classList.remove("platform-ios","platform-android","platform-web"),t.classList.remove("context-portrait","context-landscape"),t.classList.add(`device-${e.device}`),t.classList.add(`platform-${e.platform}`),t.classList.add(`context-${e.orientation}`),e.hasTouch?t.classList.add("has-touch"):t.classList.add("no-touch"),(e.isStandalone||window.NativeFeatures&&window.NativeFeatures.isNativeApp())&&t.classList.add("app-standalone"),console.log("AppBootstrap: Applied device styles:",{device:e.device,platform:e.platform,orientation:e.orientation,hasTouch:e.hasTouch,isStandalone:e.isStandalone})},initResponsiveHandling(){window.addEventListener("resize",e(()=>{const e=DeviceContext.getContext();this.applyDeviceStyles(e)},150));const t=document.documentElement,o=()=>{const e=DeviceContext.getContext();t.style.setProperty("--current-breakpoint",e.device),t.style.setProperty("--is-touch",e.hasTouch?"1":"0"),t.style.setProperty("--is-landscape","landscape"===e.orientation?"1":"0")};o(),window.addEventListener("resize",e(o,150))},setupOrientationHandling(){const t=()=>{setTimeout(()=>{const e=DeviceContext.getContext();this.applyDeviceStyles(e),window.map&&window.map.invalidateSize(),window.dispatchEvent(new CustomEvent("appOrientationChange",{detail:{context:e}}))},100)};window.addEventListener("orientationchange",t),window.addEventListener("resize",e(t,150))},async initNativeIntegration(){window.NativeFeatures&&window.NativeFeatures.isNativeApp()?(console.log("AppBootstrap: Setting up native app integration"),window.addEventListener("nativeAppStateChange",e=>{console.log("AppBootstrap: App state changed:",e.detail),e.detail.isActive?this.handleAppActivation():this.handleAppBackground()}),window.addEventListener("nativeBackButton",e=>{console.log("AppBootstrap: Native back button pressed"),this.handleNativeBackButton()}),this.setupNativeGeolocation()):console.log("AppBootstrap: Running in web browser mode")},handleAppActivation(){window.map&&setTimeout(()=>window.map.invalidateSize(),100)},handleAppBackground(){window.StateManager&&StateManager.saveState()},handleNativeBackButton(){const e=document.querySelector(".app-modal:not([hidden])"),t=document.querySelector(".docs-drawer:not([hidden])");return e?(e.hidden=!0,void(document.querySelector(".app-overlay").hidden=!0)):t?(t.hidden=!0,void(document.querySelector(".app-overlay").hidden=!0)):void(window.NativeFeatures&&window.NativeFeatures.hasFeature("app"))},setupNativeGeolocation(){window.NativeFeatures&&(window.getEnhancedPosition=async e=>{try{const t=await window.NativeFeatures.getCurrentPosition(e);return console.log("AppBootstrap: Enhanced position obtained:",t),t}catch(e){throw console.warn("AppBootstrap: Enhanced geolocation failed:",e),e}},window.watchEnhancedPosition=(e,t)=>{try{return window.NativeFeatures.watchPosition(e,t)}catch(e){throw console.warn("AppBootstrap: Enhanced position watching failed:",e),e}})},initMap(){console.log("AppBootstrap: Initializing map"),window.map=L.map("map",{center:[-37.8136,144.9631],zoom:8,zoomSnap:.333,zoomDelta:.333,preferCanvas:!0,zoomControl:!1,attributionControl:!1}),window.DEFAULT_VIEW={center:window.map.getCenter(),zoom:window.map.getZoom()},L.control.zoom({position:"mobile"===DeviceContext.getContext().device?"bottomright":"topleft"}).addTo(window.map),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(window.map);[["lga",400],["cfa",410],["ses",420],["ambulance",430],["police",440],["frv",450]].forEach(([e,t])=>{window.map.createPane(e),window.map.getPane(e).style.zIndex=String(t)}),window.map.on("click",()=>{window.NativeFeatures&&window.NativeFeatures.hapticFeedback("light")}),window.map.on("zoomend",()=>{window.NativeFeatures&&window.NativeFeatures.hapticFeedback("light")}),window.setMap&&window.setMap(window.map)},setupUI(){console.log("AppBootstrap: Setting up UI components"),window.setupCollapsible&&(window.setupCollapsible("activeHeader","activeList",!1),window.setupCollapsible("showAllHeader","showAllList"),window.setupCollapsible("sesHeader","sesList"),window.setupCollapsible("lgaHeader","lgaList"),window.setupCollapsible("cfaHeader","cfaList"),window.setupCollapsible("policeHeader","policeList"),window.setupCollapsible("ambulanceHeader","ambulanceList"),window.setupCollapsible("frvHeader","frvList")),window.CollapsibleManager&&CollapsibleManager.init(),window.SearchManager&&SearchManager.init(),window.ActiveListManager&&ActiveListManager.init()},async loadComponents(){console.log("AppBootstrap: Loading application components");try{window.startPreloading&&window.startPreloading(),window.PolygonLoader&&await PolygonLoader.loadAllPolygons();const e=["AmbulanceLoader","PoliceLoader","SESFacilitiesLoader","CFAFacilitiesLoader"];for(const t of e)if(window[t])try{await window[t].init()}catch(e){console.warn(`AppBootstrap: Failed to load ${t}:`,e)}}catch(e){throw console.error("AppBootstrap: Component loading failed:",e),e}},setupEventHandlers(){console.log("AppBootstrap: Setting up event handlers"),window.addEventListener("sidebar-tool-click",e=>{const t=e?.detail?.index;if(window.NativeFeatures&&window.NativeFeatures.hapticFeedback("light"),3===t)this.openInfo();else if(2===t){const e=(location.hash||"").toString().match(/^#docs\/(\w+)/),t=e?e[1]:"intro";this.openDocs(t)}});const t=document.getElementById("infoClose"),o=document.getElementById("docsClose"),n=document.getElementById("infoOverlay"),i=document.getElementById("docsOverlay");t&&t.addEventListener("click",()=>this.closeInfo()),n&&n.addEventListener("click",()=>this.closeInfo()),o&&o.addEventListener("click",()=>this.closeDocs()),i&&i.addEventListener("click",()=>this.closeDocs()),document.querySelectorAll(".docs-toc a[data-doc]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.getAttribute("data-doc");o&&(window.NativeFeatures&&window.NativeFeatures.hapticFeedback("light"),history.replaceState(null,"",`#docs/${o}`),this.openDocs(o))})}),window.addEventListener("resize",e(()=>{window.MobileDocsNav&&window.MobileDocsNav.setupDocsNavigation()},250)),window.MobileDocsNav&&window.MobileDocsNav.setupDocsNavigation(),window.addEventListener("keydown",e=>{"Escape"===e.key&&(this.closeInfo(),this.closeDocs())})},handleInitialLocation(){"mobile"!==DeviceContext.getContext().device&&"true"!==localStorage.getItem("autoLocate")||this.requestUserLocation()},async requestUserLocation(){try{let e;if(console.log("AppBootstrap: Requesting user location"),e=window.getEnhancedPosition?await window.getEnhancedPosition({enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5}):await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:1e4,maximumAge:3e5})}),e&&window.map){const t=e.latitude||e.coords.latitude,o=e.longitude||e.coords.longitude;L.marker([t,o],{icon:L.divIcon({className:"user-location-marker",html:"📍",iconSize:[20,20],iconAnchor:[10,10]})}).addTo(window.map).bindPopup("Your location"),window.map.setView([t,o],12),window.NativeFeatures&&window.NativeFeatures.hapticFeedback("success"),console.log("AppBootstrap: User location set:",{lat:t,lng:o})}}catch(e){console.warn("AppBootstrap: Geolocation failed:",e),window.NativeFeatures&&window.NativeFeatures.hapticFeedback("error")}},openDocs(e="intro"){fetch(`docs/${e}.md`).then(e=>e.text()).then(t=>{const o=document.getElementById("docsContent");o&&(o.innerHTML=this.parseMarkdown(t));const n=document.getElementById("docsOverlay"),i=document.getElementById("docsDrawer");n&&(n.hidden=!1),i&&(i.hidden=!1),window.MobileDocsNav&&window.MobileDocsNav.setupDocsNavigation(),window.location.hash!==`#docs/${e}`&&history.replaceState(null,"",`#docs/${e}`);const a=document.getElementById("docsClose");a&&a.focus()}).catch(e=>{console.error("Failed to load documentation:",e);const t=document.getElementById("docsContent");t&&(t.innerHTML="<p>Failed to load documentation.</p>"),window.MobileDocsNav&&window.MobileDocsNav.setupDocsNavigation()})},highlightCurrentDocsPage(){const e=document.querySelector(".docs-toc");if(!e)return;const t=window.location.hash.match(/^#docs\/(\w+)/),o=t?t[1]:"intro";e.querySelectorAll("a[data-doc]").forEach(e=>{e.classList.remove("active")});const n=e.querySelector(`a[data-doc="${o}"]`);n&&n.classList.add("active")},closeDocs(){const e=document.getElementById("docsOverlay"),t=document.getElementById("docsDrawer");e&&(e.hidden=!0),t&&(t.hidden=!0)},openInfo(){const e=document.getElementById("infoOverlay"),t=document.getElementById("infoModal");e&&(e.hidden=!1),t&&(t.hidden=!1);const o=document.getElementById("infoClose");o&&o.focus()},closeInfo(){const e=document.getElementById("infoOverlay"),t=document.getElementById("infoModal");e&&(e.hidden=!0),t&&(t.hidden=!0)},parseMarkdown:e=>e.replace(/^### (.*$)/gim,"<h3>$1</h3>").replace(/^## (.*$)/gim,"<h2>$1</h2>").replace(/^# (.*$)/gim,"<h1>$1</h1>").replace(/\*\*(.*)\*\*/gim,"<strong>$1</strong>").replace(/\*(.*)\*/gim,"<em>$1</em>").replace(/!\[([^\]]*)\]\(([^\)]*)\)/gim,'<img alt="$1" src="$2" />').replace(/\[([^\]]*)\]\(([^\)]*)\)/gim,'<a href="$2">$1</a>').replace(/`([^`]*)`/gim,"<code>$1</code>").replace(/^\* (.*$)/gim,"<li>$1</li>").replace(/(<li>.*<\/li>)/gims,"<ul>$1</ul>").replace(/\n\n/gim,"</p><p>").replace(/^(?!<[h|u|l])/gim,"<p>").replace(/$/gim,"</p>")},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>AppBootstrap.init()):AppBootstrap.init(),["ses","lga","cfa","frv"].forEach(e=>{try{const t=window.categoryMeta?.[e]?.styleFn;if("function"==typeof t){const o=t();o&&o.color&&(window.outlineColors[e]=o.color)}}catch{}}),Object.entries({sesHeader:"ses",lgaHeader:"lga",cfaHeader:"cfa",ambulanceHeader:"ambulance",policeHeader:"police",frvHeader:"frv"}).forEach(([e,t])=>{const o=document.getElementById(e);if(o){o.classList.add("category-header");const e=window.outlineColors[t],n=window.headerColorAdjust[t]??1;o.style.color=window.adjustHexColor(e,n);const i=o.querySelector(".collapse-arrow");i&&(i.style.color=window.adjustHexColor(e,Math.max(0,n-.1)))}});let t=!1;async function o(){if(!t)try{await window.loadPolice(),t=!0}catch(e){console.error("Police load failed:",e)}}async function n(e){try{await async function(){window.marked&&window.DOMPurify||await Promise.all([new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)}),new Promise((e,t)=>{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js",o.onload=e,o.onerror=t,document.head.appendChild(o)})])}();const t=await fetch(`docs/${e}.md`,{cache:"no-cache"}),o=await t.text(),n=window.DOMPurify.sanitize(window.marked.parse(o)),i=document.getElementById("docsContent");i&&(i.innerHTML=n)}catch(e){const t=document.getElementById("docsContent");t&&(t.innerHTML='<p style="color:#b00020">Failed to load documentation.</p>')}}function i(e){const t=document.getElementById("docsOverlay"),o=document.getElementById("docsDrawer");t&&(t.hidden=!1),o&&(o.hidden=!1),e&&n(e);const i=document.querySelector(`.docs-toc a[data-doc="${e}"]`);i&&(document.querySelectorAll(".docs-toc a").forEach(e=>e.classList.remove("active")),i.classList.add("active"));const a=document.getElementById("docsContent");a&&a.focus(),window.MobileDocsNav&&window.MobileDocsNav.onDocsOpen(),window.dispatchEvent(new CustomEvent("docs-opened",{detail:{slug:e}}))}function a(){const e=document.getElementById("docsOverlay"),t=document.getElementById("docsDrawer");e&&(e.hidden=!0),t&&(t.hidden=!0)}function d(){const e=document.getElementById("infoOverlay"),t=document.getElementById("infoModal");e&&(e.hidden=!0),t&&(t.hidden=!0)}(()=>{const e=document.getElementById("policeHeader"),t=document.getElementById("policeList");e&&t&&e.addEventListener("click",()=>{setTimeout(()=>{"none"!==t.style.display&&o()},0)})})(),(()=>{const e=document.getElementById("toggleAllPolice");if(!e)return;const t=async n=>{e.removeEventListener("change",t);const i=e.checked;await o(),e.checked=i,e.dispatchEvent(new Event("change",{bubbles:!0}))};e.addEventListener("change",t)})(),window.loadWaterwayCentres(),window.initSearch(),window.updateActiveList(),window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("layerMenu");if(!e)return;let t=document.getElementById("sidebarToggle");t||(t=document.createElement("button"),t.id="sidebarToggle",t.className="sidebar-toggle",t.type="button",t.setAttribute("aria-controls","layerMenu"),t.setAttribute("aria-expanded","true"),t.title="Hide panel",t.textContent="⏩",document.body.appendChild(t));try{const o=localStorage.getItem("sidebarMinimized"),n=getComputedStyle(document.documentElement),i=parseInt(n.getPropertyValue("--mobile-large")?.replace("px",""))||768;if("1"===o||null===o&&window.innerWidth<i){e.classList.add("sidebar-minimized");try{e.inert=!0}catch{}t.setAttribute("aria-expanded","false"),t.title="Show panel",t.textContent="⏪"}}catch{}t.addEventListener("click",()=>{const o=e.classList.toggle("sidebar-minimized"),n=!o;try{e.inert=o}catch{}t.setAttribute("aria-expanded",n?"true":"false"),t.title=n?"Hide panel":"Show panel",t.textContent=n?"⏩":"⏪";try{localStorage.setItem("sidebarMinimized",o?"1":"0")}catch{}}),["sidebarBtn1","sidebarBtn2","sidebarBtn3"].forEach((e,t)=>{const o=document.getElementById(e);o&&!o._bound&&(o._bound=!0,o.addEventListener("click",()=>{console.log(`Sidebar tool ${t+1} clicked`),window.dispatchEvent(new CustomEvent("sidebar-tool-click",{detail:{index:t+1,id:e}}))}))})}),window.setupOfflineListener(),window.addEventListener("deviceContextReady",e=>{const t=e.detail.context;console.log("Bootstrap: Device context ready:",t),t.isPWA&&(document.body.classList.add("pwa-mode"),console.log("Bootstrap: PWA mode enabled")),t.platform.startsWith("ios")?document.body.classList.add("ios-device"):t.platform.startsWith("android")&&document.body.classList.add("android-device"),document.body.classList.add(`breakpoint-${t.breakpoint}`)}),window.addEventListener("deviceContextChange",e=>{const{context:t,type:o}=e.detail;if(console.log("Bootstrap: Device context changed:",o,t),"orientation"===o){const e=document.getElementById("layerMenu");e&&t.isMobile&&("landscape"===t.orientation&&t.height<500?e.style.maxHeight="90vh":e.style.maxHeight="80vh"),document.body.className=document.body.className.replace(/breakpoint-\w+/,""),document.body.classList.add(`breakpoint-${t.breakpoint}`)}}),window.addEventListener("appVisibilityChange",e=>{const{visible:t}=e.detail;if(console.log("Bootstrap: App visibility changed:",t),t)try{window.resumeOperations?.()}catch(e){console.warn("Failed to resume operations:",e)}else try{window.pauseOperations?.()}catch(e){console.warn("Failed to pause operations:",e)}}),window.addEventListener("sidebar-tool-click",async e=>{try{const t=e?.detail||{};if(1!==t.index&&"sidebarBtn1"!==t.id)return;try{window.beginActiveListBulk()}catch{}const o=document.getElementById("globalSidebarSearch");o&&(o.value="");const n=document.getElementById("sidebarSearchDropdown");n&&(n.classList.remove("active"),n.style.display="none",n.innerHTML="");const i=document.getElementById("weatherBox");i&&(i.style.display="none",i.innerHTML=""),["ses","lga","cfa","ambulance","police","frv"].forEach(e=>{const t=window.nameLabelMarkers?.[e]||{};Object.keys(t).forEach(t=>{try{window.removeLabel(e,t)}catch{}try{window.emphasised[e][t]=!1}catch{}})});["sesList","lgaList","cfaList","ambulanceList","policeList","frvList"].forEach(e=>{const t=document.getElementById(e);t&&t.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked&&(e.checked=!1,e.dispatchEvent(new Event("change",{bubbles:!0})))})}),["toggleAllSES","toggleAllLGAs","toggleAllCFA","toggleAllAmbulance","toggleAllPolice","toggleAllFRV"].forEach(e=>{const t=document.getElementById(e);t&&(t.checked=!1)});try{window.updateActiveList()}catch{}["active","showAll","ses","lga","cfa","ambulance","police","frv"].forEach(e=>{const t=document.getElementById(`${e}Header`),o=document.getElementById(`${e}List`);t&&t.classList.add("collapsed"),o&&(o.style.display="none")});try{window.hideWaterwayCentres()}catch{}try{mapInstance.setView(DEFAULT_VIEW.center,DEFAULT_VIEW.zoom)}catch{}try{const e=document.getElementById("layerMenu"),t=document.getElementById("sidebarToggle");if(e&&t){e.classList.remove("sidebar-minimized");try{e.inert=!1}catch{}t.setAttribute("aria-expanded","true"),t.title="Hide panel",t.textContent="⏩"}localStorage.setItem("sidebarMinimized","0")}catch{}try{window.endActiveListBulk()}catch{}setTimeout(()=>{try{["ses","lga","cfa","ambulance","police"].forEach(e=>{const t=window.nameLabelMarkers?.[e]||{};Object.keys(t).forEach(t=>{try{window.removeLabel(e,t)}catch{}try{window.emphasised[e][t]=!1}catch{}})})}catch{}},0),console.log("Reset to default starting state complete.")}catch(e){console.error("Reset to defaults failed:",e)}}),window.addEventListener("sidebar-tool-click",e=>{const t=e?.detail?.index;if(3===t)!function(){const e=document.getElementById("infoOverlay"),t=document.getElementById("infoModal");e&&(e.hidden=!1),t&&(t.hidden=!1);const o=document.getElementById("infoClose");o&&o.focus()}();else if(2===t){const e=(location.hash||"").toString().match(/^#docs\/(\w+)/);i(e?e[1]:"intro")}}),window.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("infoClose"),t=document.getElementById("docsClose"),o=document.getElementById("infoOverlay"),n=document.getElementById("docsOverlay");e&&e.addEventListener("click",d),o&&o.addEventListener("click",d),t&&t.addEventListener("click",a),n&&n.addEventListener("click",a),document.querySelectorAll(".docs-toc a[data-doc]").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault();const o=e.getAttribute("data-doc");o&&(history.replaceState(null,"",`#docs/${o}`),i(o),window.NativeFeatures&&window.NativeFeatures.hapticFeedback("light"))})})}),window.addEventListener("keydown",e=>{"Escape"===e.key&&(d(),a())})}();
