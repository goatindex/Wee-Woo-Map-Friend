<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Source System Test - Phase 1A Diagnostics</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>üîç Phase 1A: Source System Deep Diagnostics</h1>
    
    <div class="test-section" id="test-controls">
        <h2>Test Controls</h2>
        <button class="test-button" id="test-system-load" onclick="testSystemLoad()">Test System Load</button>
        <button class="test-button" id="test-fab-framework" onclick="testFABFramework()">Test FAB Framework</button>
        <button class="test-button" id="test-bootstrap-init" onclick="testBootstrapInit()">Test Bootstrap Init</button>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        <button class="test-button" onclick="exportLogs()">Export Logs</button>
    </div>
    
    <div class="test-section" id="system-status">
        <h2>System Status</h2>
        <div id="systemStatus"></div>
    </div>
    
    <div class="test-section" id="diagnostic-logs">
        <h2>Diagnostic Logs</h2>
        <div id="logOutput" class="log-output"></div>
    </div>
    
    <div class="test-section">
        <h2>Performance Metrics</h2>
        <div id="performanceMetrics"></div>
    </div>

    <!-- Load source system scripts -->
    <script src="../js/device.js"></script>
    <script src="../js/native/features.js"></script>
    <script src="../js/fab/BaseFAB.js"></script>
    <script src="../js/fab/FABManager.js"></script>
    <script src="../js/fab/DocsFAB.js"></script>
    <script src="../js/fab/SidebarToggleFAB.js"></script>
    <script src="../js/loaders/waterwaycent.js"></script>
    <script src="../js/ui/search.js"></script>
    <script src="../js/ui/activeList.js"></script>
    <script src="../js/utils/errorUI.js"></script>
    <script src="../js/bootstrap.js"></script>

    <script>
        // Enhanced logging system for testing
        const TestLogger = {
            logs: [],
            maxLogs: 1000,
            
            log(level, component, message, data = null) {
                const timestamp = new Date().toISOString();
                const logEntry = {
                    timestamp,
                    level,
                    component,
                    message,
                    data,
                    formatted: `[${timestamp}] [${level.toUpperCase()}] [${component}]: ${message}`
                };
                
                this.logs.push(logEntry);
                if (this.logs.length > this.maxLogs) {
                    this.logs.shift();
                }
                
                // Display in UI
                this.displayLog(logEntry);
                
                // Also log to console
                if (data) {
                    console.log(logEntry.formatted, data);
                } else {
                    console.log(logEntry.formatted);
                }
            },
            
            displayLog(logEntry) {
                const logOutput = document.getElementById('logOutput');
                const logLine = document.createElement('div');
                logLine.textContent = logEntry.formatted;
                logOutput.appendChild(logLine);
                logOutput.scrollTop = logOutput.scrollHeight;
            },
            
            clear() {
                this.logs = [];
                document.getElementById('logOutput').innerHTML = '';
            },
            
            export() {
                const dataStr = JSON.stringify(this.logs, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `source-system-diagnostics-${new Date().toISOString().slice(0,19)}.json`;
                link.click();
                URL.revokeObjectURL(url);
            }
        };

        // Test functions
        function testSystemLoad() {
            TestLogger.log('info', 'TestRunner', 'Starting system load test');
            
            // Test script loading
            const scripts = [
                'device.js',
                'features.js', 
                'BaseFAB.js',
                'FABManager.js',
                'DocsFAB.js',
                'SidebarToggleFAB.js',
                'bootstrap.js'
            ];
            
            scripts.forEach(script => {
                const status = window[script.replace('.js', '').replace('/', '.')] ? '‚úÖ Loaded' : '‚ùå Not Loaded';
                TestLogger.log('info', 'TestRunner', `Script ${script}: ${status}`);
            });
            
            // Test global objects
            const globalObjects = [
                'DeviceContext',
                'NativeFeatures', 
                'BaseFAB',
                'FABManager',
                'DocsFAB',
                'SidebarToggleFAB',
                'AppBootstrap'
            ];
            
            globalObjects.forEach(objName => {
                const status = window[objName] ? '‚úÖ Available' : '‚ùå Not Available';
                TestLogger.log('info', 'TestRunner', `Global object ${objName}: ${status}`);
            });
            
            updateSystemStatus();
        }
        
        function testFABFramework() {
            TestLogger.log('info', 'TestRunner', 'Starting FAB framework test');
            
            if (!window.FABManager) {
                TestLogger.log('error', 'TestRunner', 'FABManager not available');
                return;
            }
            
            // Test FAB registration
            TestLogger.log('info', 'TestRunner', 'Testing FAB registration', {
                registeredTypes: Array.from(window.FABManager.types.keys()),
                totalTypes: window.FABManager.types.size
            });
            
            // Test FAB creation
            try {
                const docsFab = window.FABManager.create('docsFab');
                TestLogger.log('info', 'TestRunner', 'DocsFAB created successfully', docsFab);
            } catch (error) {
                TestLogger.log('error', 'TestRunner', 'Failed to create DocsFAB', error);
            }
            
            try {
                const sidebarFab = window.FABManager.create('sidebarToggle');
                TestLogger.log('info', 'TestRunner', 'SidebarToggleFAB created successfully', sidebarFab);
            } catch (error) {
                TestLogger.log('error', 'TestRunner', 'Failed to create SidebarToggleFAB', error);
            }
            
            updateSystemStatus();
        }
        
        function testBootstrapInit() {
            TestLogger.log('info', 'TestRunner', 'Starting bootstrap initialization test');
            
            if (!window.AppBootstrap) {
                TestLogger.log('error', 'TestRunner', 'AppBootstrap not available');
                return;
            }
            
            // Test bootstrap initialization
            try {
                TestLogger.log('info', 'TestRunner', 'Calling AppBootstrap.init()');
                window.AppBootstrap.init().then(() => {
                    TestLogger.log('info', 'TestRunner', 'AppBootstrap.init() completed successfully');
                    updateSystemStatus();
                }).catch(error => {
                    TestLogger.log('error', 'TestRunner', 'AppBootstrap.init() failed', error);
                    updateSystemStatus();
                });
            } catch (error) {
                TestLogger.log('error', 'TestRunner', 'Failed to call AppBootstrap.init()', error);
                updateSystemStatus();
            }
        }
        
        function updateSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let statusHTML = '';
            
            // Check script loading
            const scriptsLoaded = {
                'DeviceContext': !!window.DeviceContext,
                'NativeFeatures': !!window.NativeFeatures,
                'BaseFAB': !!window.BaseFAB,
                'FABManager': !!window.FABManager,
                'DocsFAB': !!window.DocsFAB,
                'SidebarToggleFAB': !!window.SidebarToggleFAB,
                'AppBootstrap': !!window.AppBootstrap
            };
            
            const loadedCount = Object.values(scriptsLoaded).filter(Boolean).length;
            const totalCount = Object.keys(scriptsLoaded).length;
            
            statusHTML += `<div class="status ${loadedCount === totalCount ? 'success' : 'warning'}">
                Scripts: ${loadedCount}/${totalCount} loaded
            </div>`;
            
            // Check FAB framework
            if (window.FABManager) {
                const fabTypes = Array.from(window.FABManager.types.keys());
                const fabInstances = window.FABManager.instances.size;
                
                statusHTML += `<div class="status ${fabTypes.length > 0 ? 'success' : 'warning'}">
                    FAB Types: ${fabTypes.length} registered
                </div>`;
                
                statusHTML += `<div class="status ${fabInstances > 0 ? 'success' : 'warning'}">
                    FAB Instances: ${fabInstances} created
                </div>`;
            } else {
                statusHTML += `<div class="status error">FAB Framework: Not Available</div>`;
            }
            
            statusDiv.innerHTML = statusHTML;
        }
        
        function clearLogs() {
            TestLogger.clear();
        }
        
        function exportLogs() {
            TestLogger.export();
        }
        
        // Initialize test environment
        document.addEventListener('DOMContentLoaded', () => {
            TestLogger.log('info', 'TestRunner', 'Test environment initialized');
            updateSystemStatus();
        });
    </script>
</body>
</html>
